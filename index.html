!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FRUITAS V9.0 - Excel Deep Sync</title>

  <!-- Librerías Externas -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Inter', sans-serif; }
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: #f1f5f9; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    
    @keyframes slideIn {
      from { transform: translateY(-20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .animate-slideIn { animation: slideIn 0.3s ease-out forwards; }

    input:focus {
      background-color: rgba(59, 130, 246, 0.05);
    }
  </style>

  <script type="importmap">
  {
    "imports": {
      "react": "https://esm.sh/react@19.0.0",
      "react-dom/client": "https://esm.sh/react-dom@19.0.0/client"
    }
  }
  </script>
</head>
<body class="bg-slate-50 text-slate-900 overflow-hidden">
  <div id="root"></div>

  <script type="text/babel" data-type="module">
    import React, { useState, useRef, useCallback } from 'react';
    import ReactDOM from 'react-dom/client';

    // --- CONSTANTES ---
    const COLUMNS = [
      { key: 'code', label: 'CÓD.', width: 'w-24' },
      { key: 'name', label: 'PRODUCTO', width: 'w-64' },
      { key: 'unit', label: 'UNIDAD', width: 'w-32' },
      { key: 'calvia', label: 'CALVIA', width: 'w-28' },
      { key: 'palmanova', label: 'PALMANOVA', width: 'w-28' },
      { key: 'magaluf', label: 'MAGALUF', width: 'w-28' },
      { key: 'ocell', label: 'OCELL DEL PARADÍS', width: 'w-28' },
      { key: 'santaPonsa', label: 'SANTA PONSA', width: 'w-28' },
      { key: 'bendinat', label: 'BENDINAT', width: 'w-28' },
      { key: 'picarol', label: 'ES PICAROL', width: 'w-28' },
      { key: 'vedellet', label: 'ES VEDELLET', width: 'w-28' },
      { key: 'molinet', label: 'ES MOLINET', width: 'w-28' },
      { key: 'naBurguesa', label: 'NA BURGUESA', width: 'w-28' },
    ];

    const INITIAL_DATA = [
      { code: '1409', name: 'FRESAS', unit: 'Kg', locations: {} },
      { code: '3512', name: 'KIWIS', unit: 'Kg', locations: { calvia: '3', palmanova: '4', ocell: '3', bendinat: '4', picarol: '2', naBurguesa: '5' } },
      { code: '3542', name: 'LIMÓN', unit: 'Kg', locations: { palmanova: '1', magaluf: '1' } },
      { code: '5686', name: 'MANZANA GOLDEN', unit: 'Kg', locations: { palmanova: '6', magaluf: '15', ocell: '5', picarol: '2', vedellet: '3', molinet: '4', naBurguesa: '14' } },
      { code: '2571', name: 'MELOCOTÓN', unit: 'Kg', locations: {} },
      { code: '3578', name: 'MELÓN', unit: 'Kg', locations: { calvia: '2', palmanova: '6', santaPonsa: '3' } },
      { code: '3604', name: 'NARANJA NAVEL', unit: 'Kg', locations: { calvia: '8', palmanova: '6', magaluf: '10', ocell: '5', picarol: '3', vedellet: '5', molinet: '3', naBurguesa: '5' } },
      { code: '3683', name: 'CLEMENTINA', unit: 'Kg', locations: { calvia: '5', palmanova: '6', magaluf: '10', ocell: '8', santaPonsa: '6', bendinat: '4', picarol: '3', vedellet: '5', molinet: '5', naBurguesa: '8' } },
      { code: '3591', name: 'NECTARINA', unit: 'Kg', locations: {} },
      { code: '6001', name: 'PERAS BLANQUILLA', unit: 'Kg', locations: { ocell: '12' } },
      { code: '6400', name: 'PERA CONFERENCIA', unit: 'Kg', locations: { calvia: '8', palmanova: '8', magaluf: '15', santaPonsa: '8', bendinat: '6', picarol: '3', vedellet: '6', molinet: '4', naBurguesa: '14' } },
      { code: '1706', name: 'PLATANOS PRIMERA', unit: 'UNIDAD', locations: { calvia: '60', palmanova: '100', magaluf: '120', ocell: '100', santaPonsa: '100', bendinat: '100', picarol: '100', vedellet: '80', molinet: '100', naBurguesa: '110' } },
      { code: '4790', name: 'SANDIA', unit: 'Kg', locations: {} },
      { code: '10', name: 'ACELGAS', unit: 'Manojo', locations: { calvia: '2', magaluf: '4', ocell: '2', santaPonsa: '2', bendinat: '1', picarol: '1' } },
      { code: '3041', name: 'AJO BLANCO', unit: 'Kg', locations: { palmanova: '1', magaluf: '1', santaPonsa: '1', bendinat: '1' } },
      { code: '3080', name: 'APIO', unit: 'Manojo', locations: { santaPonsa: '1', bendinat: '1', picarol: '1', molinet: '1' } },
      { code: '4123', name: 'BERENJENA', unit: 'Kg', locations: {} },
      { code: '4142', name: 'BONIATO ROJO', unit: 'Kg', locations: {} },
      { code: '458', name: 'BROCOLI', unit: 'Kg', locations: {} },
      { code: '4180', name: 'CALABACINES VERDES', unit: 'Kg', locations: { calvia: '8', palmanova: '4', magaluf: '8', ocell: '4', santaPonsa: '1', bendinat: '4', picarol: '2', molinet: '4' } },
      { code: '1160', name: 'CALABAZA', unit: 'Kg', locations: { calvia: '4', palmanova: '1', magaluf: '6', ocell: '2', santaPonsa: '1' } },
      { code: '230', name: 'CEBOLLAS', unit: 'Kg', locations: { calvia: '2', palmanova: '3', magaluf: '6', ocell: '1', santaPonsa: '3', bendinat: '3', picarol: '2', vedellet: '3' } },
      { code: '1244', name: 'CHAMPIÑONES', unit: 'Bandeja', locations: { palmanova: '3', magaluf: '4', bendinat: '2' } },
      { code: '300', name: 'COL', unit: 'UNIDAD', locations: {} },
      { code: '380', name: 'ESPINACAS', unit: 'Manojo', locations: { calvia: '1', palmanova: '1', magaluf: '1', ocell: '2', santaPonsa: '1', bendinat: '1', picarol: '1', vedellet: '2' } },
      { code: '500', name: 'LAUREL', unit: 'Manojo', locations: { magaluf: '1', santaPonsa: '1', picarol: '1' } },
      { code: '3521', name: 'LECHUGA Iceberg', unit: 'Unidad', locations: { calvia: '1', palmanova: '2', magaluf: '3', ocell: '2', santaPonsa: '1', bendinat: '2', vedellet: '1', molinet: '2' } },
      { code: '518', name: 'NABOS', unit: 'Kg', locations: {} },
      { code: '692', name: 'PATATAS', unit: 'Bolsa 5 KG', multiplier: 5, locations: { calvia: '4', santaPonsa: '1', bendinat: '3', picarol: '1', molinet: '1' } },
      { code: '691', name: 'PATATAS', unit: 'Bolsa 25 Kg', multiplier: 25, locations: { magaluf: '2', ocell: '1', picarol: '1', vedellet: '1' } },
      { code: '9660', name: 'PEPINOS', unit: 'Kg', locations: {} },
      { code: '670', name: 'PEREJIL', unit: 'Manojo', locations: { palmanova: '1', magaluf: '1', ocell: '1', santaPonsa: '1', picarol: '1' } },
      { code: '4720', name: 'PIMIENTO ROJO', unit: 'Kg', locations: { calvia: '1', palmanova: '2', magaluf: '2', ocell: '2', santaPonsa: '2', bendinat: '2', picarol: '1', vedellet: '1', molinet: '2' } },
      { code: '4725', name: 'PIMIENTO VERDE Italiano', unit: 'Kg', locations: { calvia: '0,5', palmanova: '2', magaluf: '2', ocell: '2', santaPonsa: '1', bendinat: '1', picarol: '1', vedellet: '1' } },
      { code: '782', name: 'PUERROS', unit: 'Manojo', locations: { calvia: '4', magaluf: '10', ocell: '8', santaPonsa: '8', bendinat: '7', picarol: '5', vedellet: '6', molinet: '2' } },
      { code: '9905', name: 'TOMATES Daniela ensalada', unit: 'Kg', locations: { calvia: '6', palmanova: '3', magaluf: '4', ocell: '6', santaPonsa: '4', bendinat: '5', picarol: '2', vedellet: '3' } },
      { code: '9907', name: 'TOMATES Daniela', unit: 'Kg', locations: { palmanova: '3', magaluf: '6', ocell: '4', bendinat: '5', picarol: '2', vedellet: '2', molinet: '4', naBurguesa: '2' } },
      { code: '1980', name: 'ZANAHORIAS', unit: 'Bolsa 5 Kg', multiplier: 5, locations: { calvia: '1', magaluf: '2', ocell: '2', santaPonsa: '1', bendinat: '1', vedellet: '1' } },
      { code: '3471', name: 'HINOJO', unit: 'Manojo', locations: { calvia: '1' } },
      { code: '801', name: 'CEBOLLETA', unit: 'Manojo', locations: { magaluf: '2', santaPonsa: '3', vedellet: '1' } },
      { code: '360', name: 'COLIFLOR', unit: 'Unidad', locations: { santaPonsa: '1' } },
    ];

    // --- COMPONENTES ---

    const Toast = ({ message, isError, onClose }) => (
      <div className={`fixed top-24 right-8 p-5 rounded-2xl shadow-2xl z-50 border-b-4 animate-slideIn flex items-center gap-4 transition-all ${
        isError ? 'bg-rose-600 text-white border-rose-800' : 'bg-slate-900 text-blue-400 border-blue-600'
      }`}>
        <div className="flex items-center gap-3">
          {isError ? (
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="3" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
          ) : (
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="3" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
          )}
          <span className="font-black text-xs uppercase tracking-widest">{message}</span>
        </div>
        <button onClick={onClose} className="text-white/50 hover:text-white transition-colors">
          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2.5" d="M6 18L18 6M6 6l12 12" /></svg>
        </button>
      </div>
    );

    const DataTable = ({ data, columns, onCellChange, onCopyColumn, calculateValue }) => (
      <div className="bg-white rounded-3xl shadow-2xl border border-slate-200 overflow-hidden">
        <div className="overflow-x-auto">
          <table className="w-full text-left border-collapse table-fixed min-w-[1500px]">
            <thead className="bg-slate-900 sticky top-0 z-20 text-white">
              <tr>
                {columns.map((col, idx) => (
                  <th key={col.key} className={`${col.width} p-0 text-center border-r border-slate-800 last:border-0`}>
                    <div className="py-5 px-2 flex flex-col items-center justify-between min-h-[110px]">
                      <span className={`text-[10px] font-black uppercase tracking-tight h-10 flex items-center text-center leading-tight ${idx < 3 ? 'text-slate-500' : 'text-white'}`}>
                        {col.label}
                      </span>
                      {idx >= 3 && (
                        <button 
                          onClick={() => onCopyColumn(col.key)} 
                          className="bg-blue-600 hover:bg-blue-500 text-white text-[9px] font-black py-2 px-3 rounded-xl shadow-[0_3px_0_rgb(29,78,216)] active:translate-y-0.5 active:shadow-none transition-all uppercase"
                        >
                          COPIAR + COD
                        </button>
                      )}
                    </div>
                  </th>
                ))}
              </tr>
            </thead>
            <tbody className="divide-y divide-slate-100">
              {data.map((row, rIndex) => (
                <tr key={rIndex} className="hover:bg-blue-50/40 transition-colors group divide-x divide-slate-50">
                  <td className="px-2 py-3 text-[11px] font-bold text-slate-300 text-center bg-slate-50/30">{row.code}</td>
                  <td className="px-4 py-3 text-sm font-black text-slate-800 uppercase truncate group-hover:text-blue-600">{row.name}</td>
                  <td className="px-2 py-3 text-[10px] text-slate-400 font-bold uppercase text-center bg-slate-50/50">
                    {row.unit}
                    {row.multiplier && <span className="block text-[9px] text-emerald-600 font-black mt-1">x {row.multiplier} KG</span>}
                  </td>
                  {columns.slice(3).map((col) => {
                    const val = row.locations[col.key] || "";
                    const total = calculateValue(val, row.multiplier);
                    const hasVal = val.trim() !== "" && val !== "0";
                    return (
                      <td key={col.key} className={`p-0 relative transition-all ${hasVal ? 'bg-blue-50/60' : ''}`}>
                        <input
                          type="text"
                          value={val}
                          onChange={(e) => onCellChange(rIndex, col.key, e.target.value)}
                          className={`w-full h-full min-h-[56px] p-2 text-center text-sm font-black bg-transparent border-0 outline-none focus:ring-2 focus:ring-blue-500 focus:ring-inset ${hasVal ? 'text-blue-700' : 'text-slate-300'}`}
                          placeholder="-"
                        />
                        {row.multiplier && hasVal && (
                          <div className="absolute top-1 right-1 px-1.5 py-0.5 text-[9px] font-black text-white bg-emerald-500 rounded-md shadow-sm pointer-events-none">{total}</div>
                        )}
                      </td>
                    );
                  })}
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>
    );

    // --- APP PRINCIPAL ---

    const App = () => {
      const [data, setData] = useState(INITIAL_DATA);
      const [feedback, setFeedback] = useState(null);
      const [showImport, setShowImport] = useState(false);
      const fileInputRef = useRef(null);

      const notify = useCallback((message, isError = false) => {
        setFeedback({ message, isError });
        if (!isError) setTimeout(() => setFeedback(null), 5000);
      }, []);

      const normalize = (val) => {
        if (val === null || val === undefined) return "";
        return String(val).trim().normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase().replace(/\s+/g, ' ');
      };

      const handleCellChange = useCallback((rowIndex, colKey, value) => {
        setData(prev => {
          const newData = [...prev];
          const targetRow = { ...newData[rowIndex] };
          if (['code', 'name', 'unit'].includes(colKey)) targetRow[colKey] = value;
          else targetRow.locations = { ...targetRow.locations, [colKey]: value };
          newData[rowIndex] = targetRow;
          return newData;
        });
      }, []);

      const clearAllLocations = useCallback(() => {
        setData(prev => prev.map(row => ({ ...row, locations: {} })));
        if (fileInputRef.current) fileInputRef.current.value = "";
        notify("Cantidades limpiadas.");
      }, [notify]);

      const handleFileUpload = (e) => {
        const file = e.target.files?.[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (evt) => {
          try {
            const dataBuffer = evt.target?.result;
            const XLSX = window.XLSX;
            const wb = XLSX.read(dataBuffer, { type: 'array' });
            const ws = wb.Sheets[wb.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "" });

            if (jsonData.length === 0) return notify("Archivo vacío.", true);

            setData(prev => {
              const newData = prev.map(item => ({ ...item, locations: { ...item.locations } }));
              let matchCount = 0;
              let colMapping = {};

              // Detección de cabeceras
              for (let i = 0; i < Math.min(jsonData.length, 30); i++) {
                const row = jsonData[i] || [];
                const rowNorm = Array.from(row).map(c => normalize(c));
                if (rowNorm.some(c => c && (c.includes("COD") || c.includes("ART") || c.includes("PROD")))) {
                  COLUMNS.slice(3).forEach(col => {
                    const keyword = normalize(col.label).split(' ')[0];
                    const foundIdx = rowNorm.findIndex(c => c && c.includes(keyword));
                    if (foundIdx !== -1) colMapping[col.key] = foundIdx;
                  });
                }
              }

              // Procesamiento con Escaneo Profundo
              jsonData.forEach((row) => {
                if (!row || row.length === 0) return;
                let targetIdx = -1;
                const searchRange = Math.min(row.length, 25);
                for (let c = 0; c < searchRange; c++) {
                  const cellVal = normalize(row[c]);
                  if (!cellVal) continue;
                  targetIdx = newData.findIndex(p => {
                    const pCode = normalize(p.code);
                    const pName = normalize(p.name);
                    return (pCode === cellVal && pCode !== "") || (pName === cellVal && pName !== "") || (cellVal.length > 6 && pName.includes(cellVal));
                  });
                  if (targetIdx !== -1) break;
                }
                if (targetIdx !== -1) {
                  matchCount++;
                  COLUMNS.slice(3).forEach((col, colIdx) => {
                    let val = (colMapping[col.key] !== undefined) ? String(row[colMapping[col.key]] || "").trim() : String(row[colIdx + 3] || "").trim();
                    if (val !== "" && val !== "0" && val.toLowerCase() !== "undefined") newData[targetIdx].locations[col.key] = val;
                  });
                }
              });

              if (matchCount > 0) notify(`Sincronizados ${matchCount} productos.`);
              else notify("No se encontraron coincidencias.", true);
              return newData;
            });
            setShowImport(false);
          } catch (err) { notify("Error al leer Excel.", true); }
        };
        reader.readAsArrayBuffer(file);
      };

      const calculateValue = (val, multiplier) => {
        if (!multiplier || !val || val.trim() === '' || val.trim() === '0') return val;
        const num = parseFloat(val.replace(',', '.'));
        return isNaN(num) ? val : (num * multiplier).toFixed(2).replace('.', ',');
      };

      const copyFullTable = useCallback(() => {
        let tsv = COLUMNS.map(col => col.label).join('\t') + '\n';
        let count = 0;
        data.forEach(row => {
          if (Object.values(row.locations).some(v => v && v !== "" && v !== "0")) {
            count++;
            tsv += [row.code, row.name, row.unit, ...COLUMNS.slice(3).map(col => calculateValue(row.locations[col.key] || "", row.multiplier))].join('\t') + '\n';
          }
        });
        if (count === 0) return notify("Nada que copiar.", true);
        navigator.clipboard.writeText(tsv).then(() => notify(`Copiadas ${count} filas.`));
      }, [data, notify]);

      const copyColumn = useCallback((colKey) => {
        let tsv = ""; let count = 0;
        data.forEach(row => {
          const val = row.locations[colKey];
          if (val && val !== "" && val !== "0") { count++; tsv += `${row.code}\t${calculateValue(val, row.multiplier)}\n`; }
        });
        if (count === 0) return notify("Columna vacía.", true);
        navigator.clipboard.writeText(tsv).then(() => notify(`Copiado: ${COLUMNS.find(c=>c.key===colKey).label}`));
      }, [data, notify]);

      return (
        <div className="flex flex-col h-screen bg-slate-50">
          <header className="bg-slate-900 text-white px-6 py-4 flex flex-col md:flex-row justify-between items-center gap-4 shadow-2xl z-30 shrink-0">
            <div className="flex items-center gap-4">
              <div className="bg-blue-600 p-2.5 rounded-xl shadow-lg ring-1 ring-blue-400/50">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><path d="M11 20H4a2 2 0 0 1-2-2V5c0-1.1.9-2 2-2h5l2 3h9a2 2 0 0 1 2 2v10M11 20l4-4M11 20l4 4M11 20h11" /></svg>
              </div>
              <div>
                <h1 className="text-xl font-black italic uppercase leading-none italic">FRUITAS V9.0</h1>
                <p className="text-[10px] text-blue-400 font-bold tracking-[0.15em] uppercase mt-1">Deep Sync Motor</p>
              </div>
            </div>
            <div className="flex gap-2">
              <button onClick={() => setShowImport(!showImport)} className="bg-slate-800 hover:bg-slate-700 px-5 py-2.5 rounded-xl font-bold text-xs border border-slate-700 transition-all">SUBIR EXCEL</button>
              <button onClick={clearAllLocations} className="bg-rose-600 hover:bg-rose-500 px-5 py-2.5 rounded-xl font-bold text-xs shadow-[0_4px_0_rgb(159,18,57)] active:translate-y-1 active:shadow-none transition-all">LIMPIAR</button>
              <button onClick={copyFullTable} className="bg-emerald-500 hover:bg-emerald-400 text-emerald-950 px-6 py-2.5 rounded-xl font-black text-xs shadow-[0_4px_0_rgb(5,150,105)] active:translate-y-1 active:shadow-none transition-all">COPIAR TODO</button>
            </div>
          </header>

          {feedback && <Toast {...feedback} onClose={() => setFeedback(null)} />}

          {showImport && (
            <div className="bg-white p-8 border-b-4 border-blue-100 animate-slideIn flex justify-center shadow-inner">
              <input ref={fileInputRef} type="file" accept=".xlsx, .xls" onChange={handleFileUpload} className="hidden" />
              <div onClick={() => fileInputRef.current.click()} className="w-full max-w-2xl border-4 border-dashed border-slate-200 rounded-3xl p-12 hover:border-blue-500 hover:bg-blue-50 transition-all cursor-pointer text-center">
                <div className="inline-block p-4 bg-blue-600 rounded-2xl text-white mb-4"><svg className="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" strokeWidth="2.5"/></svg></div>
                <h2 className="text-xl font-black text-slate-800 uppercase italic">Haz clic para cargar el pedido</h2>
                <p className="text-slate-400 text-xs font-bold mt-2 uppercase tracking-widest italic">Escaneo profundo habilitado (Cód/Nombre)</p>
              </div>
            </div>
          )}

          <main className="flex-1 overflow-auto p-4 bg-slate-200/40">
            <DataTable data={data} columns={COLUMNS} onCellChange={handleCellChange} onCopyColumn={copyColumn} calculateValue={calculateValue} />
          </main>

          <footer className="bg-slate-900 text-white px-6 py-3 flex justify-between items-center text-[10px] font-black tracking-widest uppercase">
            <div className="flex items-center gap-2"><div className="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></div><span>Sincronización Inteligente Activa</span></div>
            <div className="flex gap-4 text-slate-500"><span>{data.length} PRODUCTOS</span><span>V9.1.0 STABLE</span></div>
          </footer>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
